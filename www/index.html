<!DOCTYPE html>
<html>
    <head>
        <title>Example</title>
        <script>
            const d = document;

            function getRequest(url, onFailure, onSuccess) {
                const request = new XMLHttpRequest();
                request.onreadystatechange = () => {
                    if (request.readyState != 4) {
                        return;
                    }
                    if (request.status !== 200) {
                        onFailure(request);
                        return;
                    }
                    onSuccess(request);
                }
                request.open('GET', url);
                request.send();
                return request;
            }

            function postJsonRequest(url, data, onFailure, onSuccess) {
                const request = new XMLHttpRequest();
                request.onreadystatechange = () => {
                    if (request.readyState != 4) {
                        return;
                    }
                    if (request.status !== 200) {
                        onFailure(request);
                        return;
                    }
                    onSuccess(request);
                }
                request.open('POST', url);
                request.setRequestHeader("Content-type", "application/json");
                request.send(JSON.stringify(data));
                return request;
            }

            function setNetworkCofig() {
                const button = d.getElementById('save-config-btn');
                button.disabled = true;
                postJsonRequest('/network-config', {
                    'ssid': d.getElementById('network-ssid-input').value,
                    'password': d.getElementById('network-password-input').value,
                },
                    () => {
                        alert('Failed to set network config');
                        button.disabled = false;
                    },
                    r => {
                        updateStatus(JSON.parse(r.responseText));
                        button.disabled = false;
                    });
            }

            function onNetworkSelectionChanged() {
                d.getElementById('network-ssid-input').value = d.getElementById('network-selecter').value;
            }

            function updateStatus(status)
            {
                d.getElementById('status-active').innerHTML = status ? (status.active ? 'Yes' : 'No') : 'Loading...';
                d.getElementById('status-ssid').innerHTML = status ? (status.active ? status.ssid : '') : 'Loading...';
                d.getElementById('status-ip').innerHTML = status ? (status.active ? status.ip : '') : 'Loading...';
            }

            function getStatus() {
                const button = d.getElementById('get-status-btn')
                button.disabled = true;
                updateStatus();
                getRequest('/status',
                    () => {
                        alert('Failed to get status');
                        button.disabled = false;
                    },
                    r => {
                        updateStatus(JSON.parse(r.responseText));
                        button.disabled = false;
                    });
            }

            function addSelectOption(selectElement, label, value)
            {
                var optionEl = d.createElement('option');
                optionEl.setAttribute('value', value || '');
                optionEl.innerHTML = label;
                selectElement.appendChild(optionEl);
            }

            function getNetworks() {
                const button = d.getElementById('get-networks-btn');
                button.disabled = true;
                const selectEl = d.getElementById('network-selecter');
                selectEl.innerHTML = '';
                addSelectOption(selectEl, 'Loading...');
                getRequest('/networks',
                    () => {
                        alert('Failed to get network list');
                        button.disabled = false;
                    },
                    r => {
                        const result = JSON.parse(r.responseText);
                        selectEl.innerHTML = '';
                        addSelectOption(selectEl, 'Select a network');
                        result.forEach(network => {
                            addSelectOption(selectEl, network.ssid + ' (' + network.rssi + ')', network.ssid);
                        });
                        button.disabled = false;
                  });
            }

            window.onload = () => {
                getStatus();
                getNetworks();
            }
        </script>
    </head>
    <body>
        <h1>E-SPrinkler Network Configuration</h1>
        <h2>Current Status <button id="get-status-btn" onclick="getStatus()">Refresh</button></h2>
        <dl id="status">
            <dt>Active</dt>
            <dd id="status-active"></dd>
            <dt>SSID</dt>
            <dd id="status-ssid"></dd>
            <dt>IP Address</dt>
            <dd id="status-ip"></dd>
        </dl>
        <h2>Set Network</h2>
        <div>
            <label>Available:<label>
            <select id="network-selecter" onchange="onNetworkSelectionChanged()"></select>
            <button id="get-networks-btn" onclick="getNetworks()">Refresh</button>
        </div>
        <dl id="status">
            <dt>SSID</dt>
            <dd><input type="text" id="network-ssid-input" /></dd>
            <dt>Password</dt>
            <dd><input type="password" id="network-password-input" /></dd>
        </dl>
        <div>
            <button id="save-config-btn" onclick="setNetworkCofig()">Save</button>
        </div>
    </body>
</html>
